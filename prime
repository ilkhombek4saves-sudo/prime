#!/usr/bin/env bash
set -euo pipefail

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
CONFIG_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/prime/config"

is_project_root() {
  local dir="$1"
  [ -f "$dir/docker-compose.yml" ] && [ -f "$dir/scripts/onboard.py" ]
}

read_config_prime_home() {
  local cfg="$1"
  [ -f "$cfg" ] || return 1
  local line
  line="$(grep -E '^PRIME_HOME=' "$cfg" | tail -n 1 || true)"
  [ -n "$line" ] || return 1
  local value="${line#PRIME_HOME=}"
  [ -n "$value" ] || return 1
  printf '%s' "$value"
}

find_root_from_pwd() {
  local dir="$PWD"
  while true; do
    if is_project_root "$dir"; then
      printf '%s' "$dir"
      return 0
    fi
    if [ "$dir" = "/" ]; then
      return 1
    fi
    dir="$(dirname "$dir")"
  done
}

resolve_root() {
  local candidate

  if [ -n "${PRIME_HOME:-}" ] && is_project_root "${PRIME_HOME}"; then
    printf '%s' "${PRIME_HOME}"
    return 0
  fi

  candidate="$(read_config_prime_home "$CONFIG_FILE" || true)"
  if [ -n "$candidate" ] && is_project_root "$candidate"; then
    printf '%s' "$candidate"
    return 0
  fi

  if is_project_root "$SCRIPT_DIR"; then
    printf '%s' "$SCRIPT_DIR"
    return 0
  fi

  candidate="$(find_root_from_pwd || true)"
  if [ -n "$candidate" ]; then
    printf '%s' "$candidate"
    return 0
  fi

  return 1
}

ROOT="$(resolve_root || true)"

dc() {
  docker compose --project-directory "$ROOT" -f "$ROOT/docker-compose.yml" "$@"
}

require_root() {
  if [ -n "$ROOT" ]; then
    return 0
  fi
  cat >&2 <<'EOF'
prime: project root not found.
Run command from project directory, or set PRIME_HOME.
Example:
  export PRIME_HOME=/path/to/ownCLI
  prime status
EOF
  exit 1
}

usage() {
  cat <<'EOF'
Usage:
  prime <command> [args]

Commands:
  onboard             Run interactive setup wizard
  doctor              Run health diagnostics
  seed                Seed demo data
  start               Start services (detached)
  up                  Alias for start
  build               Build Docker images
  rebuild             Rebuild images without cache
  status              Show service status
  logs [service]      Follow logs (default: backend)
  stop                Stop services
  down                Alias for stop
  restart             Restart backend service
  gateway <subcmd>    Gateway ops (status/start/stop/restart/logs/health/url)
  channels <subcmd>   Telegram channel ops (list/doctor/connect/verify)
  dashboard [--open]  Show dashboard URL (or open it in browser)
  shell               Open backend shell
  db                  Open PostgreSQL shell
  test                Run backend tests
  migrate             Apply Alembic migrations
  auth <subcommand>   Auth commands (login/status/whoami/logout/refresh)
  where               Print detected project root
  help                Show this help
EOF
}

cmd="${1:-help}"
shift || true

case "$cmd" in
  onboard)
    require_root
    exec python3 "$ROOT/scripts/onboard.py" "$@"
    ;;
  doctor)
    require_root
    exec python3 "$ROOT/scripts/onboard.py" --doctor "$@"
    ;;
  seed)
    require_root
    exec python3 "$ROOT/scripts/onboard.py" --seed "$@"
    ;;
  start)
    require_root
    dc up -d "$@"
    ;;
  up)
    require_root
    dc up -d "$@"
    ;;
  build)
    require_root
    dc build "$@"
    ;;
  rebuild)
    require_root
    dc build --no-cache "$@"
    ;;
  status)
    require_root
    dc ps "$@"
    ;;
  logs)
    require_root
    if [ "$#" -eq 0 ]; then
      dc logs -f backend
      exit 0
    fi
    dc logs -f "$@"
    ;;
  stop)
    require_root
    dc down "$@"
    ;;
  down)
    require_root
    dc down "$@"
    ;;
  restart)
    require_root
    dc restart backend "$@"
    ;;
  gateway)
    require_root
    exec python3 "$ROOT/scripts/gateway.py" "$@"
    ;;
  channels)
    require_root
    exec python3 "$ROOT/scripts/channels.py" "$@"
    ;;
  dashboard)
    require_root
    exec python3 "$ROOT/scripts/gateway.py" dashboard "$@"
    ;;
  shell)
    require_root
    dc exec backend bash
    ;;
  db)
    require_root
    dc exec db psql -U postgres multibot
    ;;
  test)
    require_root
    dc exec backend pytest /app/tests -v
    ;;
  migrate)
    require_root
    dc exec backend bash -lc "PYTHONPATH=/app alembic -c /app/alembic.ini upgrade head"
    ;;
  auth)
    require_root
    exec python3 "$ROOT/scripts/auth.py" "$@"
    ;;
  where)
    require_root
    echo "$ROOT"
    ;;
  help|-h|--help)
    usage
    ;;
  *)
    echo "Unknown command: $cmd" >&2
    echo
    usage
    exit 1
    ;;
esac
